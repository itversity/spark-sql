
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2.11. Basic Transformations &#8212; Apache Spark using SQL</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. Basic DDL and DML" href="../03_basic_ddl_and_dml/01_basic_ddl_and_dml.html" />
    <link rel="prev" title="2.10. Basic Transformations" href="11_conclusion_final_solution.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  
  <h1 class="site-logo" id="site-title">Apache Spark using SQL</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-sql.html">
   Apache Spark using SQL
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../01_getting_started/01_getting_started.html">
   1. Getting Started
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="reference internal" href="01_basic_transformations.html">
   2. Basic Transformations
  </a>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="02_spark_sql_overview.html">
     2.1. Spark SQL – Overview
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="03_define_problem_statement.html">
     2.2. Define Problem Statement
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="04_preparing_tables.html">
     2.3. Preparing Tables
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="05_projecting_data.html">
     2.4. Projecting Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="06_filtering_data.html">
     2.5. Filtering Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="07_joining_tables_inner.html">
     2.6. Joining Tables - Inner
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="08_joining_tables_outer.html">
     2.7. Joining Tables - Outer
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="09_aggregating_data.html">
     2.8. Basic Transformations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="10_sorting_data.html">
     2.9. Basic Transformations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="11_conclusion_final_solution.html">
     2.10. Basic Transformations
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     2.11. Basic Transformations
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../03_basic_ddl_and_dml/01_basic_ddl_and_dml.html">
   3. Basic DDL and DML
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../04_dml_and_partitioning/01_dml_and_partitioning.html">
   4. DML and Partitioning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../05_predefined_functions/01_predefined_functions.html">
   5. Pre-defined Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../06_windowing_functions/01_windowing_functions.html">
   6. Windowing Functions
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Subscribe to our <a href="http://notifyme.itversity.com">Newsletter</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/02_basic_transformations/12_exercises_basic_sql_queries.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/itversity/spark-sql"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/itversity/spark-sql/issues/new?title=Issue%20on%20page%20%2F02_basic_transformations/12_exercises_basic_sql_queries.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/itversity/spark-sql/edit/master/02_basic_transformations/12_exercises_basic_sql_queries.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/itversity/spark-sql/master?urlpath=tree/02_basic_transformations/12_exercises_basic_sql_queries.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#spark-sql-overview">
   2.11.1. Spark SQL – Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-problem-statement">
   2.11.2. Define Problem Statement
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preparing-tables">
   2.11.3. Preparing Tables
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#projecting-data">
   2.11.4. Projecting Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#filtering-data">
   2.11.5. Filtering Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joining-tables-inner">
   2.11.6. Joining Tables - Inner
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joining-tables-outer">
   2.11.7. Joining Tables - Outer
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aggregating-data">
   2.11.8. Aggregating Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sorting-data">
   2.11.9. Sorting Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion-final-solution">
   2.11.10. Conclusion - Final Solution
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercises-basic-sql-queries">
   2.11.11. Exercises - Basic SQL Queries
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-1-customer-order-count">
     2.11.11.1. Exercise 1 - Customer order count
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-2-dormant-customers">
     2.11.11.2. Exercise 2 - Dormant Customers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-3-revenue-per-customer">
     2.11.11.3. Exercise 3 - Revenue Per Customer
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-4-revenue-per-category">
     2.11.11.4. Exercise 4 - Revenue Per Category
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-5-product-count-per-department">
     2.11.11.5. Exercise 5 - Product Count Per Department
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="basic-transformations">
<h1><span class="section-number">2.11. </span>Basic Transformations<a class="headerlink" href="#basic-transformations" title="Permalink to this headline">¶</a></h1>
<p>As part of this section we will see basic transformations we can perform on top of Data Frames such as filtering, aggregations, joins etc using SQL. We will build end to end solution by taking a simple problem statement.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/w4IZNOCEcd4?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></div></div>
</div>
<ul class="simple">
<li><p>Spark SQL – Overview</p></li>
<li><p>Define Problem Statement</p></li>
<li><p>Preparing Tables</p></li>
<li><p>Projecting Data</p></li>
<li><p>Filtering Data</p></li>
<li><p>Joining Tables - Inner</p></li>
<li><p>Joining Tables - Outer</p></li>
<li><p>Perform Aggregations</p></li>
<li><p>Sorting Data</p></li>
<li><p>Conclusion - Final Solution</p></li>
</ul>
<p>If you are going to use CLIs, you can use Spark SQL using one of the 3 approaches.</p>
<p><strong>Using Spark SQL</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>spark2-sql \
    --master yarn \
    --conf spark.ui.port=0 \
    --conf spark.sql.warehouse.dir=/user/${USER}/warehouse
</pre></div>
</div>
<p><strong>Using Scala</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>spark2-shell \
    --master yarn \
    --conf spark.ui.port=0 \
    --conf spark.sql.warehouse.dir=/user/${USER}/warehouse
</pre></div>
</div>
<p><strong>Using Pyspark</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pyspark2 \
    --master yarn \
    --conf spark.ui.port=0 \
    --conf spark.sql.warehouse.dir=/user/${USER}/warehouse
</pre></div>
</div>
<div class="section" id="spark-sql-overview">
<h2><span class="section-number">2.11.1. </span>Spark SQL – Overview<a class="headerlink" href="#spark-sql-overview" title="Permalink to this headline">¶</a></h2>
<p>Let us get an overview of Spark SQL.</p>
<p>Here are the standard operations which we typically perform as part of processing the data. In Spark we can perform these using Data Frame APIs or <strong>Spark SQL</strong>.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/R7n6wDILtos?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></div></div>
</div>
<ul class="simple">
<li><p>Selection or Projection – select clause</p>
<ul>
<li><p>It is also called as row level transformations.</p></li>
<li><p>Apply standardization rules (convert names and addresses to upper case).</p></li>
<li><p>Mask partial data (SSN and Date of births).</p></li>
</ul>
</li>
<li><p>Filtering data – where clause</p>
<ul>
<li><p>Get orders based on date or product or category.</p></li>
</ul>
</li>
<li><p>Joins – join (supports outer join as well)</p>
<ul>
<li><p>Join multiple data sets.</p></li>
</ul>
</li>
<li><p>Aggregations – group by and aggregations with support of functions such as sum, avg, min, max etc</p>
<ul>
<li><p>Get revenue for a given order</p></li>
<li><p>Get revenue for each order</p></li>
<li><p>Get daily revenue</p></li>
</ul>
</li>
<li><p>Sorting – order by</p>
<ul>
<li><p>Sort the final output by date.</p></li>
<li><p>Sort the final output by date, then by revenue in descending order.</p></li>
<li><p>Sort the final output by state or province, then by revenue in descending order.</p></li>
</ul>
</li>
<li><p>Analytics Functions – aggregations, ranking and windowing functions</p>
<ul>
<li><p>Get top 5 stores by revenue for each state.</p></li>
<li><p>Get top 5 products by revenue in each category.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span>

<span class="k">val</span> <span class="n">username</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;user.name&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">spark</span> <span class="o">=</span> <span class="nc">SparkSession</span><span class="o">.</span>
    <span class="n">builder</span><span class="o">.</span>
    <span class="n">config</span><span class="o">(</span><span class="s">&quot;spark.ui.port&quot;</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">).</span>
    <span class="n">config</span><span class="o">(</span><span class="s">&quot;spark.sql.warehouse.dir&quot;</span><span class="o">,</span> <span class="s">s&quot;/user/</span><span class="si">${</span><span class="n">username</span><span class="si">}</span><span class="s">/warehouse&quot;</span><span class="o">).</span>
    <span class="n">enableHiveSupport</span><span class="o">.</span>
    <span class="n">appName</span><span class="o">(</span><span class="s">s&quot;</span><span class="si">${</span><span class="n">username</span><span class="si">}</span><span class="s"> | Spark SQL - Basic Transformations&quot;</span><span class="o">).</span>
    <span class="n">master</span><span class="o">(</span><span class="s">&quot;yarn&quot;</span><span class="o">).</span>
    <span class="n">getOrCreate</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="define-problem-statement">
<h2><span class="section-number">2.11.2. </span>Define Problem Statement<a class="headerlink" href="#define-problem-statement" title="Permalink to this headline">¶</a></h2>
<p>Let us define problemt statement to get an overview of basic transformations using Spark SQL.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/dRbLxxpSeS8?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></div></div>
</div>
<ul class="simple">
<li><p>Get Daily Product Revenue using orders and order_items data set.</p></li>
<li><p>We have following fields in <strong>orders</strong>.</p>
<ul>
<li><p>order_id</p></li>
<li><p>order_date</p></li>
<li><p>order_customer_id</p></li>
<li><p>order_status</p></li>
</ul>
</li>
<li><p>We have following fields in <strong>order_items</strong>.</p>
<ul>
<li><p>order_item_id</p></li>
<li><p>order_item_order_id</p></li>
<li><p>order_item_product_id</p></li>
<li><p>order_item_quantity</p></li>
<li><p>order_item_subtotal</p></li>
<li><p>order_item_product_price</p></li>
</ul>
</li>
<li><p>We have one to many relationship between orders and order_items.</p></li>
<li><p><strong>orders.order_id</strong> is <strong>primary key</strong> and <strong>order_items.order_item_order_id</strong> is foreign key to <strong>orders.order_id</strong>.</p></li>
<li><p>By the end of this module we will explore all standard transformation and get daily product revenue using following fields.</p>
<ul>
<li><p><strong>orders.order_date</strong></p></li>
<li><p><strong>order_items.order_item_product_id</strong></p></li>
<li><p><strong>order_items.order_item_subtotal</strong> (aggregated using date and product_id).</p></li>
</ul>
</li>
<li><p>We will consider only <strong>COMPLETE</strong> or <strong>CLOSED</strong> orders.</p></li>
</ul>
</div>
<div class="section" id="preparing-tables">
<h2><span class="section-number">2.11.3. </span>Preparing Tables<a class="headerlink" href="#preparing-tables" title="Permalink to this headline">¶</a></h2>
<p>Let us prepare the tables to solve the problem.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/TZlQ2hohgck?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></div></div>
</div>
<ul class="simple">
<li><p>Make sure database is created.</p></li>
<li><p>Create <strong>orders</strong> table.</p></li>
<li><p>Load data from local path <strong>/data/retail_db/orders</strong> into newly created <strong>orders</strong> table.</p></li>
<li><p>Preview data and get count from <strong>orders</strong></p></li>
<li><p>Create <strong>order_items</strong> table.</p></li>
<li><p>Load data from local path <strong>/data/retail_db/order_items</strong> into newly created <strong>orders</strong> table.</p></li>
<li><p>Preview data and get count from <strong>order_items</strong></p></li>
</ul>
<p>As tables and data are ready let us get into how to write queries against tables to perform basic transformation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">DROP</span> <span class="nc">DATABASE</span> <span class="n">itversity_retail</span> <span class="nc">CASCADE</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">CREATE</span> <span class="nc">DATABASE</span> <span class="nc">IF</span> <span class="nc">NOT</span> <span class="nc">EXISTS</span> <span class="n">itversity_retail</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="nc">USE</span> <span class="n">itversity_retail</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="nc">SHOW</span> <span class="n">tables</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">DROP</span> <span class="nc">TABLE</span> <span class="n">orders</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">CREATE</span> <span class="nc">TABLE</span> <span class="n">orders</span> <span class="o">(</span>
    <span class="n">order_id</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">order_date</span> <span class="nc">STRING</span><span class="o">,</span>
    <span class="n">order_customer_id</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">order_status</span> <span class="nc">STRING</span>
<span class="o">)</span> <span class="nc">ROW</span> <span class="nc">FORMAT</span> <span class="nc">DELIMITED</span> <span class="nc">FIELDS</span> <span class="nc">TERMINATED</span> <span class="nc">BY</span> <span class="sc">&#39;,&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">sys.process._</span>
<span class="k">val</span> <span class="n">username</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;user.name&quot;</span><span class="o">)</span>
<span class="s">s&quot;hdfs dfs -ls /user/itversity/warehouse/</span><span class="si">${</span><span class="n">username</span><span class="si">}</span><span class="s">_retail.db/orders&quot;</span><span class="o">!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

LOAD DATA LOCAL INPATH &#39;/data/retail_db/orders&#39; INTO TABLE orders
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">sys.process._</span>
<span class="k">val</span> <span class="n">username</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;user.name&quot;</span><span class="o">)</span>
<span class="s">s&quot;hdfs dfs -ls /user/itversity/warehouse/</span><span class="si">${</span><span class="n">username</span><span class="si">}</span><span class="s">_retail.db/orders&quot;</span><span class="o">!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="o">*</span> <span class="nc">FROM</span> <span class="n">orders</span> <span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">count</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="nc">FROM</span> <span class="n">orders</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">DROP</span> <span class="nc">TABLE</span> <span class="n">order_items</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span> 

<span class="nc">CREATE</span> <span class="nc">TABLE</span> <span class="n">order_items</span> <span class="o">(</span>
    <span class="n">order_item_id</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">order_item_order_id</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">order_item_product_id</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">order_item_quantity</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">order_item_subtotal</span> <span class="nc">FLOAT</span><span class="o">,</span>
    <span class="n">order_item_product_price</span> <span class="nc">FLOAT</span>
<span class="o">)</span> <span class="nc">ROW</span> <span class="nc">FORMAT</span> <span class="nc">DELIMITED</span> <span class="nc">FIELDS</span> <span class="nc">TERMINATED</span> <span class="nc">BY</span> <span class="sc">&#39;,&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">sys.process._</span>
<span class="k">val</span> <span class="n">username</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;user.name&quot;</span><span class="o">)</span>
<span class="s">s&quot;hdfs dfs -ls /user/itversity/warehouse/</span><span class="si">${</span><span class="n">username</span><span class="si">}</span><span class="s">_retail.db/order_items&quot;</span><span class="o">!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

LOAD DATA LOCAL INPATH &#39;/data/retail_db/order_items&#39; INTO TABLE order_items
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">sys.process._</span>
<span class="k">val</span> <span class="n">username</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;user.name&quot;</span><span class="o">)</span>
<span class="s">s&quot;hdfs dfs -ls /user/itversity/warehouse/</span><span class="si">${</span><span class="n">username</span><span class="si">}</span><span class="s">_retail.db/order_items&quot;</span><span class="o">!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="o">*</span> <span class="nc">FROM</span> <span class="n">order_items</span> <span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">count</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="nc">FROM</span> <span class="n">order_items</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Using Spark SQL with Python or Scala</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;DROP DATABASE itversity_retail CASCADE&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;CREATE DATABASE IF NOT EXISTS itversity_retail&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;USE itversity_retail&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SHOW tables&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;DROP TABLE orders&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">CREATE TABLE orders (</span>
<span class="s">    order_id INT,</span>
<span class="s">    order_date STRING,</span>
<span class="s">    order_customer_id INT,</span>
<span class="s">    order_status STRING</span>
<span class="s">) ROW FORMAT DELIMITED FIELDS TERMINATED BY &#39;,&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">sys.process._</span>
<span class="k">val</span> <span class="n">username</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;user.name&quot;</span><span class="o">)</span>
<span class="s">s&quot;hdfs dfs -ls /user/itversity/warehouse/</span><span class="si">${</span><span class="n">username</span><span class="si">}</span><span class="s">_retail.db/orders&quot;</span><span class="o">!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;LOAD DATA LOCAL INPATH &#39;/data/retail_db/orders&#39; INTO TABLE orders&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">sys.process._</span>
<span class="k">val</span> <span class="n">username</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;user.name&quot;</span><span class="o">)</span>
<span class="s">s&quot;hdfs dfs -ls /user/itversity/warehouse/</span><span class="si">${</span><span class="n">username</span><span class="si">}</span><span class="s">_retail.db/orders&quot;</span><span class="o">!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT * FROM orders LIMIT 10&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT count(1) FROM orders&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;DROP TABLE order_items&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">CREATE TABLE order_items (</span>
<span class="s">    order_item_id INT,</span>
<span class="s">    order_item_order_id INT,</span>
<span class="s">    order_item_product_id INT,</span>
<span class="s">    order_item_quantity INT,</span>
<span class="s">    order_item_subtotal FLOAT,</span>
<span class="s">    order_item_product_price FLOAT</span>
<span class="s">) ROW FORMAT DELIMITED FIELDS TERMINATED BY &#39;,&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">sys.process._</span>
<span class="k">val</span> <span class="n">username</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;user.name&quot;</span><span class="o">)</span>
<span class="s">s&quot;hdfs dfs -ls /user/itversity/warehouse/</span><span class="si">${</span><span class="n">username</span><span class="si">}</span><span class="s">_retail.db/order_items&quot;</span><span class="o">!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;LOAD DATA LOCAL INPATH &#39;/data/retail_db/order_items&#39; INTO TABLE order_items&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">sys.process._</span>
<span class="k">val</span> <span class="n">username</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;user.name&quot;</span><span class="o">)</span>
<span class="s">s&quot;hdfs dfs -ls /user/itversity/warehouse/</span><span class="si">${</span><span class="n">username</span><span class="si">}</span><span class="s">_retail.db/order_items&quot;</span><span class="o">!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT * FROM order_items LIMIT 10&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT count(1) FROM order_items&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="projecting-data">
<h2><span class="section-number">2.11.4. </span>Projecting Data<a class="headerlink" href="#projecting-data" title="Permalink to this headline">¶</a></h2>
<p>Let us understand different aspects of projecting data. We primarily using <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> to project the data.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/8BBzd60hYFc?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></div></div>
</div>
<ul class="simple">
<li><p>We can project all columns using <code class="docutils literal notranslate"><span class="pre">*</span></code> or some columns using column names.</p></li>
<li><p>We can provide aliases to a column or expression using <code class="docutils literal notranslate"><span class="pre">AS</span></code> in <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DISTINCT</span></code> can be used to get the distinct records from selected columns. We can also use <code class="docutils literal notranslate"><span class="pre">DISTINCT</span> <span class="pre">*</span></code> to get unique records using all the columns.</p></li>
<li><p>As of now <strong>Spark SQL</strong> does not support projecting all but one or few columns. It is supported in Hive. Following will work in hive and it will project all the columns from orders except for order_id.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SET hive.support.quoted.identifiers=none;
SELECT `(order_id)?+.+` FROM orders;
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="o">*</span> <span class="nc">FROM</span> <span class="n">orders</span> <span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">DESCRIBE</span> <span class="n">orders</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">order_customer_id</span><span class="o">,</span> <span class="n">order_date</span><span class="o">,</span> <span class="n">order_status</span> <span class="nc">FROM</span> <span class="n">orders</span> <span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT order_customer_id, date_format(order_date, &#39;yyyy-MM&#39;), order_status FROM orders LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT order_customer_id, 
    date_format(order_date, &#39;yyyy-MM&#39;) AS order_month, 
    order_status 
FROM orders LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="nc">DISTINCT</span> <span class="n">order_status</span> <span class="nc">FROM</span> <span class="n">orders</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="nc">DISTINCT</span> <span class="o">*</span> <span class="nc">FROM</span> <span class="n">orders</span> <span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Using Spark SQL with Python or Scala</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT * FROM orders&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;DESCRIBE orders&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT order_customer_id, order_date, order_status FROM orders&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT order_customer_id, </span>
<span class="s">    date_format(order_date, &#39;yyyy-MM&#39;), </span>
<span class="s">    order_status </span>
<span class="s">FROM orders&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT order_customer_id, </span>
<span class="s">    date_format(order_date, &#39;yyyy-MM&#39;) AS order_month, </span>
<span class="s">    order_status </span>
<span class="s">FROM orders</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT DISTINCT order_status FROM orders&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT DISTINCT * FROM orders&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="filtering-data">
<h2><span class="section-number">2.11.5. </span>Filtering Data<a class="headerlink" href="#filtering-data" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how we can filter the data in Spark SQL.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/x6sUnQ553Ow?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></div></div>
</div>
<ul class="simple">
<li><p>We use <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause to filter the data.</p></li>
<li><p>All comparison operators such as <code class="docutils literal notranslate"><span class="pre">=</span></code>, <code class="docutils literal notranslate"><span class="pre">!=</span></code>, <code class="docutils literal notranslate"><span class="pre">&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;</span></code>, etc can be used to compare a column or expression or literal with another column or expression or literal.</p></li>
<li><p>We can use operators such as LIKE with % and regexp_like for pattern matching.</p></li>
<li><p>Boolan OR and AND can be performed when we want to apply multiple conditions.</p>
<ul>
<li><p>Get all orders with order_status equals to COMPLETE or CLOSED. We can also use IN operator.</p></li>
<li><p>Get all orders from month 2014 January with order_status equals to COMPLETE or CLOSED</p></li>
</ul>
</li>
<li><p>We need to use <code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NULL</span></code> and <code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NOT</span> <span class="pre">NULL</span></code> to compare against null values.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">USE</span> <span class="n">itversity_retail</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SHOW</span> <span class="n">tables</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT * FROM orders WHERE order_status = &#39;COMPLETE&#39; LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT count(1) FROM orders WHERE order_status = &#39;COMPLETE&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT * FROM orders WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;) LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT * FROM orders WHERE order_status = &#39;COMPLETE&#39; OR order_status = &#39;CLOSED&#39; LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT count(1) FROM orders WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT count(1) FROM orders WHERE order_status = &#39;COMPLETE&#39; OR order_status = &#39;CLOSED&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT * FROM orders 
WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND order_date LIKE &#39;2014-01%&#39;
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT count(1) FROM orders 
WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND order_date LIKE &#39;2014-01%&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT * FROM orders 
WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND date_format(order_date, &#39;yyyy-MM&#39;) = &#39;2014-01&#39;
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT count(1) FROM orders 
WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND date_format(order_date, &#39;yyyy-MM&#39;) = &#39;2014-01&#39;
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Using Spark SQL with Python or Scala</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;USE itversity_retail&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SHOW tables&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT * FROM orders WHERE order_status = &#39;COMPLETE&#39;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT count(1) FROM orders WHERE order_status = &#39;COMPLETE&#39;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT * FROM orders WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT * FROM orders </span>
<span class="s">WHERE order_status = &#39;COMPLETE&#39; OR order_status = &#39;CLOSED&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1) FROM orders </span>
<span class="s">WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1) FROM orders</span>
<span class="s">WHERE order_status = &#39;COMPLETE&#39; OR order_status = &#39;CLOSED&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT * FROM orders </span>
<span class="s">WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">    AND order_date LIKE &#39;2014-01%&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1) FROM orders </span>
<span class="s">WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">    AND order_date LIKE &#39;2014-01%&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT * FROM orders </span>
<span class="s">WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">    AND date_format(order_date, &#39;yyyy-MM&#39;) = &#39;2014-01&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1) FROM orders </span>
<span class="s">WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">    AND date_format(order_date, &#39;yyyy-MM&#39;) = &#39;2014-01&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Let us prepare the table to demonstrate how to deal with null values while filtering the data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">DROP</span> <span class="nc">DATABASE</span> <span class="nc">IF</span> <span class="nc">EXISTS</span> <span class="n">itversity_sms</span> <span class="nc">CASCADE</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">CREATE</span> <span class="nc">DATABASE</span> <span class="nc">IF</span> <span class="nc">NOT</span> <span class="nc">EXISTS</span> <span class="n">itversity_sms</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">DROP</span> <span class="nc">TABLE</span> <span class="nc">IF</span> <span class="nc">EXISTS</span> <span class="n">students</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">CREATE</span> <span class="nc">TABLE</span> <span class="n">students</span> <span class="o">(</span>
    <span class="n">student_id</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">student_first_name</span> <span class="nc">STRING</span><span class="o">,</span>
    <span class="n">student_last_name</span> <span class="nc">STRING</span><span class="o">,</span>
    <span class="n">student_phone_number</span> <span class="nc">STRING</span><span class="o">,</span>
    <span class="n">student_address</span> <span class="nc">STRING</span>
<span class="o">)</span> <span class="nc">STORED</span> <span class="nc">AS</span> <span class="n">avro</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

INSERT INTO students VALUES (1, &#39;Scott&#39;, &#39;Tiger&#39;, NULL, NULL)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

INSERT INTO students VALUES (2, &#39;Donald&#39;, &#39;Duck&#39;, &#39;1234567890&#39;, NULL)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

INSERT INTO students VALUES 
    (3, &#39;Mickey&#39;, &#39;Mouse&#39;, &#39;2345678901&#39;, &#39;A Street, One City, Some State, 12345&#39;),
    (4, &#39;Bubble&#39;, &#39;Guppy&#39;, &#39;6789012345&#39;, &#39;Bubbly Street, Guppy, La la land, 45678&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="o">*</span> <span class="nc">FROM</span> <span class="n">students</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Using Spark SQL with Python or Scala</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;DROP DATABASE IF EXISTS itversity_sms CASCADE&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;CREATE DATABASE IF NOT EXISTS itversity_sms&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;DROP TABLE IF EXISTS students&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">CREATE TABLE students (</span>
<span class="s">    student_id INT,</span>
<span class="s">    student_first_name STRING,</span>
<span class="s">    student_last_name STRING,</span>
<span class="s">    student_phone_number STRING,</span>
<span class="s">    student_address STRING</span>
<span class="s">) STORED AS avro</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">INSERT INTO students </span>
<span class="s">VALUES (1, &#39;Scott&#39;, &#39;Tiger&#39;, NULL, NULL)</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">INSERT INTO students </span>
<span class="s">VALUES (2, &#39;Donald&#39;, &#39;Duck&#39;, &#39;1234567890&#39;, NULL)</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">INSERT INTO students VALUES </span>
<span class="s">    (3, &#39;Mickey&#39;, &#39;Mouse&#39;, &#39;2345678901&#39;, &#39;A Street, One City, Some State, 12345&#39;),</span>
<span class="s">    (4, &#39;Bubble&#39;, &#39;Guppy&#39;, &#39;6789012345&#39;, &#39;Bubbly Street, Guppy, La la land, 45678&#39;)</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT * FROM students&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Comparison against null can be done with <code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NULL</span></code> and <code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NOT</span> <span class="pre">NULL</span></code>. Below query will not work even though we have one record with phone_numbers as null.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT * FROM students </span>
<span class="s">WHERE student_phone_number = NULL</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT * FROM students </span>
<span class="s">WHERE student_phone_number != NULL</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT * FROM students</span>
<span class="s">WHERE student_phone_number IS NULL</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT * FROM students</span>
<span class="s">WHERE student_phone_number IS NOT NULL</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="joining-tables-inner">
<h2><span class="section-number">2.11.6. </span>Joining Tables - Inner<a class="headerlink" href="#joining-tables-inner" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to join data from multiple tables.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/gKAhugUD218?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></div></div>
</div>
<ul class="simple">
<li><p><strong>Spark SQL</strong> supports ASCII style join (<strong>JOIN with ON</strong>).</p></li>
<li><p>There are different types of joins.</p>
<ul>
<li><p>INNER JOIN - Get all the records from both the datasets which satisfies JOIN condition.</p></li>
<li><p>OUTER JOIN - We will get into the details as part of the next topic</p></li>
</ul>
</li>
<li><p>Example for INNER JOIN</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_date</span><span class="p">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_status</span><span class="p">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_subtotal</span>
<span class="n">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="n">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="n">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
<span class="n">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
<ul class="simple">
<li><p>We can join more than 2 tables in one query. Here is how it will look like.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_date</span><span class="p">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_status</span><span class="p">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_subtotal</span>
<span class="n">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="n">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="n">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
    <span class="n">JOIN</span> <span class="n">products</span> <span class="n">p</span>
    <span class="n">ON</span> <span class="n">p</span><span class="o">.</span><span class="n">product_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_product_id</span>
<span class="n">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
<ul class="simple">
<li><p>If we have to apply additional filters, it is recommended to use WHERE clause. ON clause should only have join conditions.</p></li>
<li><p>We can have non equal join conditions as well, but they are not used that often.</p></li>
<li><p>Here are some of the examples for INNER JOIN:</p>
<ul>
<li><p>Get order id, date, status and item revenue for all order items.</p></li>
<li><p>Get order id, date, status and item revenue for all order items for all orders where order status is either COMPLETE or CLOSED.</p></li>
<li><p>Get order id, date, status and item revenue for all order items for all orders where order status is either COMPLETE or CLOSED for the orders that are placed in the month of 2014 January.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span><span class="o">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_date</span><span class="o">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_status</span><span class="o">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_subtotal</span>
<span class="nc">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="nc">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="nc">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
<span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">count</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="nc">FROM</span> <span class="n">orders</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">count</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="nc">FROM</span> <span class="n">order_items</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span><span class="o">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_date</span><span class="o">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_status</span><span class="o">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_subtotal</span>
<span class="nc">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="nc">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="nc">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
<span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">count</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="nc">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="nc">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="nc">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT o.order_id,
    o.order_date,
    o.order_status,
    oi.order_item_subtotal
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT count(1)
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT o.order_id,
    o.order_date,
    o.order_status,
    oi.order_item_subtotal
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND date_format(order_date, &#39;yyyy-MM&#39;) = &#39;2014-01&#39;
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT count(1)
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND date_format(order_date, &#39;yyyy-MM&#39;) = &#39;2014-01&#39;
LIMIT 10
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Using Spark SQL with Python or Scala</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_id,</span>
<span class="s">    o.order_date,</span>
<span class="s">    o.order_status,</span>
<span class="s">    oi.order_item_subtotal</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1)</span>
<span class="s">FROM orders</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1)</span>
<span class="s">FROM order_items</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_id,</span>
<span class="s">    o.order_date,</span>
<span class="s">    o.order_status,</span>
<span class="s">    oi.order_item_subtotal</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1)</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_id,</span>
<span class="s">    o.order_date,</span>
<span class="s">    o.order_status,</span>
<span class="s">    oi.order_item_subtotal</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1)</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_id,</span>
<span class="s">    o.order_date,</span>
<span class="s">    o.order_status,</span>
<span class="s">    oi.order_item_subtotal</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">    AND date_format(order_date, &#39;yyyy-MM&#39;) = &#39;2014-01&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1)</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">    AND date_format(order_date, &#39;yyyy-MM&#39;) = &#39;2014-01&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="joining-tables-outer">
<h2><span class="section-number">2.11.7. </span>Joining Tables - Outer<a class="headerlink" href="#joining-tables-outer" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to perform outer joins using Spark SQL. There are 3 different types of outer joins.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/RSE61x6B_90?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></div></div>
</div>
<ul class="simple">
<li><p>LEFT OUTER JOIN (default) - Get all the records from both the datasets which satisfies JOIN condition along with those records which are in the left side table but not in the right side table.</p></li>
<li><p>RIGHT OUTER JOIN - Get all the records from both the datasets which satisfies JOIN condition along with those records which are in the right side table but not in the left side table.</p></li>
<li><p>FULL OUTER JOIN - left union right</p></li>
<li><p>When we perform the outer join (lets say left outer join), we will see this.</p>
<ul>
<li><p>Get all the values from both the tables when join condition satisfies.</p></li>
<li><p>If there are rows on left side tables for which there are no corresponding values in right side table, all the projected column values for right side table will be null.</p></li>
</ul>
</li>
<li><p>Here are some of the examples for outer join.</p>
<ul>
<li><p>Get all the orders where there are no corresponding order items.</p></li>
<li><p>Get all the order items where there are no corresponding orders.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span><span class="o">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_date</span><span class="o">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_status</span><span class="o">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="o">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_subtotal</span>
<span class="nc">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="nc">LEFT</span> <span class="nc">OUTER</span> <span class="nc">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="nc">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
<span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">count</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="nc">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="nc">LEFT</span> <span class="nc">OUTER</span> <span class="nc">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="nc">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span><span class="o">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_date</span><span class="o">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_status</span><span class="o">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="o">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_subtotal</span>
<span class="nc">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="nc">LEFT</span> <span class="nc">OUTER</span> <span class="nc">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="nc">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
<span class="nc">WHERE</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span> <span class="nc">IS</span> <span class="nc">NULL</span>
<span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">count</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="nc">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="nc">LEFT</span> <span class="nc">OUTER</span> <span class="nc">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="nc">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
<span class="nc">WHERE</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span> <span class="nc">IS</span> <span class="nc">NULL</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT count(1)
FROM orders o LEFT OUTER JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE oi.order_item_order_id IS NULL
    AND o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span><span class="o">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_date</span><span class="o">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_status</span><span class="o">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="o">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_subtotal</span>
<span class="nc">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="nc">RIGHT</span> <span class="nc">OUTER</span> <span class="nc">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="nc">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
<span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">count</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="nc">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="nc">RIGHT</span> <span class="nc">OUTER</span> <span class="nc">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="nc">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span><span class="o">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_date</span><span class="o">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_status</span><span class="o">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="o">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_subtotal</span>
<span class="nc">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="nc">RIGHT</span> <span class="nc">OUTER</span> <span class="nc">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="nc">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
<span class="nc">WHERE</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="nc">IS</span> <span class="nc">NULL</span>
<span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Using Spark SQL with Python or Scala</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_id,</span>
<span class="s">    o.order_date,</span>
<span class="s">    o.order_status,</span>
<span class="s">    oi.order_item_order_id,</span>
<span class="s">    oi.order_item_subtotal</span>
<span class="s">FROM orders o LEFT OUTER JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1)</span>
<span class="s">FROM orders o LEFT OUTER JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_id,</span>
<span class="s">    o.order_date,</span>
<span class="s">    o.order_status,</span>
<span class="s">    oi.order_item_order_id,</span>
<span class="s">    oi.order_item_subtotal</span>
<span class="s">FROM orders o LEFT OUTER JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE oi.order_item_order_id IS NULL</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>spark.sql(&quot;&quot;&quot;
SELECT count(1)
FROM orders o LEFT OUTER JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE oi.order_item_order_id IS NULL
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1)</span>
<span class="s">FROM orders o LEFT OUTER JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE oi.order_item_order_id IS NULL</span>
<span class="s">    AND o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_id,</span>
<span class="s">    o.order_date,</span>
<span class="s">    o.order_status,</span>
<span class="s">    oi.order_item_order_id,</span>
<span class="s">    oi.order_item_subtotal</span>
<span class="s">FROM orders o RIGHT OUTER JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1)</span>
<span class="s">FROM orders o RIGHT OUTER JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_id,</span>
<span class="s">    o.order_date,</span>
<span class="s">    o.order_status,</span>
<span class="s">    oi.order_item_order_id,</span>
<span class="s">    oi.order_item_subtotal</span>
<span class="s">FROM orders o RIGHT OUTER JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE o.order_id IS NULL</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="aggregating-data">
<h2><span class="section-number">2.11.8. </span>Aggregating Data<a class="headerlink" href="#aggregating-data" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to aggregate the data.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/sbKVUr7fZCk?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></div></div>
</div>
<ul class="simple">
<li><p>We can perform global aggregations as well as aggregations by key.</p></li>
<li><p>Global Aggregations</p>
<ul>
<li><p>Get total number of orders.</p></li>
<li><p>Get revenue for a given order id.</p></li>
<li><p>Get number of records with order_status either COMPLETED or CLOSED.</p></li>
</ul>
</li>
<li><p>Aggregations by key - using <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code></p>
<ul>
<li><p>Get number of orders by date or status.</p></li>
<li><p>Get revenue for each order_id.</p></li>
<li><p>Get daily product revenue (using order date and product id as keys).</p></li>
</ul>
</li>
<li><p>We can also use <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> clause to apply filtering on top of aggregated data.</p>
<ul>
<li><p>Get daily product revenue where revenue is greater than $500 (using order date and product id as keys).</p></li>
</ul>
</li>
<li><p>Rules while using <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code>.</p>
<ul>
<li><p>We can have the columns which are specified as part of <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> in <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause.</p></li>
<li><p>On top of those, we can have derived columns using aggregate functions.</p></li>
<li><p>We cannot have any other columns that are not used as part of <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> on derived column using non aggregate functions.</p></li>
<li><p>We will not be able to use aggregate functions or aliases used in the select clause as part of the where clause.</p></li>
<li><p>If we want to filter based on aggregated results, then we can leverage <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> on top of <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> (specifying <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> is not an option)</p></li>
</ul>
</li>
<li><p>Typical query execution - FROM -&gt; WHERE -&gt; GROUP BY -&gt; SELECT</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">count</span><span class="o">(</span><span class="n">order_id</span><span class="o">)</span> <span class="nc">FROM</span> <span class="n">orders</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">count</span><span class="o">(</span><span class="nc">DISTINCT</span> <span class="n">order_date</span><span class="o">)</span> <span class="nc">FROM</span> <span class="n">orders</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">round</span><span class="o">(</span><span class="n">sum</span><span class="o">(</span><span class="n">order_item_subtotal</span><span class="o">),</span> <span class="mi">2</span><span class="o">)</span> <span class="nc">AS</span> <span class="n">order_revenue</span>
<span class="nc">FROM</span> <span class="n">order_items</span> 
<span class="nc">WHERE</span> <span class="n">order_item_order_id</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT count(1) 
FROM orders
WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">order_date</span><span class="o">,</span>
    <span class="n">count</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="nc">FROM</span> <span class="n">orders</span>
<span class="nc">GROUP</span> <span class="nc">BY</span> <span class="n">order_date</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">order_status</span><span class="o">,</span>
    <span class="n">count</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="nc">AS</span> <span class="n">status_count</span>
<span class="nc">FROM</span> <span class="n">orders</span>
<span class="nc">GROUP</span> <span class="nc">BY</span> <span class="n">order_status</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="n">order_item_order_id</span><span class="o">,</span>
    <span class="n">round</span><span class="o">(</span><span class="n">sum</span><span class="o">(</span><span class="n">order_item_subtotal</span><span class="o">),</span> <span class="mi">2</span><span class="o">)</span> <span class="nc">AS</span> <span class="n">order_revenue</span>
<span class="nc">FROM</span> <span class="n">order_items</span>
<span class="nc">GROUP</span> <span class="nc">BY</span> <span class="n">order_item_order_id</span> <span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal), 2) AS revenue
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date,
    oi.order_item_product_id
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal), 2) AS revenue
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND revenue &gt;= 500
GROUP BY o.order_date,
    oi.order_item_product_id
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal), 2) AS revenue
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date,
    oi.order_item_product_id
HAVING revenue &gt;= 500
LIMIT 10
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Using Spark SQL with Python or Scala</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT count(order_id) FROM orders&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SELECT count(DISTINCT order_date) FROM orders&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT round(sum(order_item_subtotal), 2) AS order_revenue</span>
<span class="s">FROM order_items </span>
<span class="s">WHERE order_item_order_id = 2</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT count(1) </span>
<span class="s">FROM orders</span>
<span class="s">WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT order_date,</span>
<span class="s">    count(1)</span>
<span class="s">FROM orders</span>
<span class="s">GROUP BY order_date</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT order_status,</span>
<span class="s">    count(1) AS status_count</span>
<span class="s">FROM orders</span>
<span class="s">GROUP BY order_status</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT order_item_order_id,</span>
<span class="s">    round(sum(order_item_subtotal), 2) AS order_revenue</span>
<span class="s">FROM order_items</span>
<span class="s">GROUP BY order_item_order_id</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_date,</span>
<span class="s">    oi.order_item_product_id,</span>
<span class="s">    round(sum(oi.order_item_subtotal), 2) AS revenue</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">GROUP BY o.order_date,</span>
<span class="s">    oi.order_item_product_id</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_date,</span>
<span class="s">    oi.order_item_product_id,</span>
<span class="s">    round(sum(oi.order_item_subtotal), 2) AS revenue</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">    AND revenue &gt;= 500</span>
<span class="s">GROUP BY o.order_date,</span>
<span class="s">    oi.order_item_product_id</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_date,</span>
<span class="s">    oi.order_item_product_id,</span>
<span class="s">    round(sum(oi.order_item_subtotal), 2) AS revenue</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">GROUP BY o.order_date,</span>
<span class="s">    oi.order_item_product_id</span>
<span class="s">HAVING revenue &gt;= 500</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="sorting-data">
<h2><span class="section-number">2.11.9. </span>Sorting Data<a class="headerlink" href="#sorting-data" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to sort the data using <strong>Spark SQL</strong>.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/zh3fWDXknfg?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></div></div>
</div>
<ul class="simple">
<li><p>We typically perform sorting as final step.</p></li>
<li><p>Sorting can be done either by using one field or multiple fields.</p></li>
<li><p>We can sort the data either in ascending order or descending order by using column or expression.</p></li>
<li><p>By default, the sorting order is ascendig and we can change it to descending by using <code class="docutils literal notranslate"><span class="pre">DESC</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="o">*</span> <span class="nc">FROM</span> <span class="n">orders</span>
<span class="nc">ORDER</span> <span class="nc">BY</span> <span class="n">order_customer_id</span>
<span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="o">*</span> <span class="nc">FROM</span> <span class="n">orders</span>
<span class="nc">ORDER</span> <span class="nc">BY</span> <span class="n">order_customer_id</span><span class="o">,</span>
    <span class="n">order_date</span>
<span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SELECT</span> <span class="o">*</span> <span class="nc">FROM</span> <span class="n">orders</span>
<span class="nc">ORDER</span> <span class="nc">BY</span> <span class="n">order_customer_id</span><span class="o">,</span>
    <span class="n">order_date</span> <span class="nc">DESC</span>
<span class="nc">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal), 2) AS revenue
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date,
    oi.order_item_product_id
ORDER BY o.order_date,
    revenue DESC
LIMIT 10
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Using Spark SQL with Python or Scala</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT * FROM orders</span>
<span class="s">ORDER BY order_customer_id</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT * FROM orders</span>
<span class="s">ORDER BY order_customer_id,</span>
<span class="s">    order_date</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT * FROM orders</span>
<span class="s">ORDER BY order_customer_id,</span>
<span class="s">    order_date DESC</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_date,</span>
<span class="s">    oi.order_item_product_id,</span>
<span class="s">    round(sum(oi.order_item_subtotal), 2) AS revenue</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">GROUP BY o.order_date,</span>
<span class="s">    oi.order_item_product_id</span>
<span class="s">ORDER BY o.order_date,</span>
<span class="s">    revenue DESC</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="conclusion-final-solution">
<h2><span class="section-number">2.11.10. </span>Conclusion - Final Solution<a class="headerlink" href="#conclusion-final-solution" title="Permalink to this headline">¶</a></h2>
<p>Let us review the Final Solution for our problem statement <strong>daily_product_revenue</strong>.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/p83npp8FYe0?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></div></div>
</div>
<ul class="simple">
<li><p>Prepare tables</p>
<ul>
<li><p>Create tables</p></li>
<li><p>Load the data into tables</p></li>
</ul>
</li>
<li><p>We need to project the fields which we are interested in.</p>
<ul>
<li><p>order_date</p></li>
<li><p>order_item_product_id</p></li>
<li><p>product_revenue</p></li>
</ul>
</li>
<li><p>As we have fields from multiple tables, we need to perform join after which we have to filter for COMPLETE or CLOSED orders.</p></li>
<li><p>We have to group the data by order_date and order_item_product_id, then we have to perform aggregation on order_item_subtotal to get product_revenue.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">DROP</span> <span class="nc">DATABASE</span> <span class="n">itversity_retail</span> <span class="nc">CASCADE</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">CREATE</span> <span class="nc">DATABASE</span> <span class="nc">IF</span> <span class="nc">NOT</span> <span class="nc">EXISTS</span> <span class="n">itversity_retail</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">USE</span> <span class="n">itversity_retail</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">SHOW</span> <span class="n">tables</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>

<span class="nc">CREATE</span> <span class="nc">TABLE</span> <span class="n">orders</span> <span class="o">(</span>
    <span class="n">order_id</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">order_date</span> <span class="nc">STRING</span><span class="o">,</span>
    <span class="n">order_customer_id</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">order_status</span> <span class="nc">STRING</span>
<span class="o">)</span> <span class="nc">ROW</span> <span class="nc">FORMAT</span> <span class="nc">DELIMITED</span> <span class="nc">FIELDS</span> <span class="nc">TERMINATED</span> <span class="nc">BY</span> <span class="sc">&#39;,&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

LOAD DATA LOCAL INPATH &#39;/data/retail_db/orders&#39; INTO TABLE orders
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span> 

<span class="nc">CREATE</span> <span class="nc">TABLE</span> <span class="n">order_items</span> <span class="o">(</span>
    <span class="n">order_item_id</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">order_item_order_id</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">order_item_product_id</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">order_item_quantity</span> <span class="nc">INT</span><span class="o">,</span>
    <span class="n">order_item_subtotal</span> <span class="nc">FLOAT</span><span class="o">,</span>
    <span class="n">order_item_product_price</span> <span class="nc">FLOAT</span>
<span class="o">)</span> <span class="nc">ROW</span> <span class="nc">FORMAT</span> <span class="nc">DELIMITED</span> <span class="nc">FIELDS</span> <span class="nc">TERMINATED</span> <span class="nc">BY</span> <span class="sc">&#39;,&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

LOAD DATA LOCAL INPATH &#39;/data/retail_db/order_items&#39; INTO TABLE order_items
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal), 2) AS product_revenue
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date,
    oi.order_item_product_id
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>%%sql

SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal), 2) AS product_revenue
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date,
    oi.order_item_product_id
ORDER BY o.order_date,
    product_revenue DESC
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Using Spark SQL with Python or Scala</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;DROP DATABASE itversity_retail CASCADE&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;CREATE DATABASE IF NOT EXISTS itversity_retail&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;USE itversity_retail&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;SHOW tables&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">CREATE TABLE orders (</span>
<span class="s">    order_id INT,</span>
<span class="s">    order_date STRING,</span>
<span class="s">    order_customer_id INT,</span>
<span class="s">    order_status STRING</span>
<span class="s">) ROW FORMAT DELIMITED FIELDS TERMINATED BY &#39;,&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">LOAD DATA LOCAL INPATH &#39;/data/retail_db/orders&#39; </span>
<span class="s">INTO TABLE orders</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">CREATE TABLE order_items (</span>
<span class="s">    order_item_id INT,</span>
<span class="s">    order_item_order_id INT,</span>
<span class="s">    order_item_product_id INT,</span>
<span class="s">    order_item_quantity INT,</span>
<span class="s">    order_item_subtotal FLOAT,</span>
<span class="s">    order_item_product_price FLOAT</span>
<span class="s">) ROW FORMAT DELIMITED FIELDS TERMINATED BY &#39;,&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">LOAD DATA LOCAL INPATH &#39;/data/retail_db/order_items&#39; </span>
<span class="s">INTO TABLE order_items</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_date,</span>
<span class="s">    oi.order_item_product_id,</span>
<span class="s">    round(sum(oi.order_item_subtotal), 2) AS product_revenue</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">GROUP BY o.order_date,</span>
<span class="s">    oi.order_item_product_id</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">SELECT o.order_date,</span>
<span class="s">    oi.order_item_product_id,</span>
<span class="s">    round(sum(oi.order_item_subtotal), 2) AS product_revenue</span>
<span class="s">FROM orders o JOIN order_items oi</span>
<span class="s">    ON o.order_id = oi.order_item_order_id</span>
<span class="s">WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)</span>
<span class="s">GROUP BY o.order_date,</span>
<span class="s">    oi.order_item_product_id</span>
<span class="s">ORDER BY o.order_date,</span>
<span class="s">    product_revenue DESC</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="exercises-basic-sql-queries">
<h2><span class="section-number">2.11.11. </span>Exercises - Basic SQL Queries<a class="headerlink" href="#exercises-basic-sql-queries" title="Permalink to this headline">¶</a></h2>
<p>Here are some of the exercises for which you can write SQL queries to self evaluate.</p>
<div class="section" id="exercise-1-customer-order-count">
<h3><span class="section-number">2.11.11.1. </span>Exercise 1 - Customer order count<a class="headerlink" href="#exercise-1-customer-order-count" title="Permalink to this headline">¶</a></h3>
<p>Get order count per customer for the month of 2014 January.</p>
<ul class="simple">
<li><p>Tables - orders and customers</p></li>
<li><p>Data should be sorted in descending order by count and ascending order by customer id.</p></li>
<li><p>Output should contain customer_id, customer_first_name, customer_last_name and customer_order_count.</p></li>
</ul>
</div>
<div class="section" id="exercise-2-dormant-customers">
<h3><span class="section-number">2.11.11.2. </span>Exercise 2 - Dormant Customers<a class="headerlink" href="#exercise-2-dormant-customers" title="Permalink to this headline">¶</a></h3>
<p>Get the customer details who have not placed any order for the month of 2014 January.</p>
<ul class="simple">
<li><p>Tables - orders and customers</p></li>
<li><p>Data should be sorted in ascending order by customer_id</p></li>
<li><p>Output should contain all the fields from customers</p></li>
</ul>
</div>
<div class="section" id="exercise-3-revenue-per-customer">
<h3><span class="section-number">2.11.11.3. </span>Exercise 3 - Revenue Per Customer<a class="headerlink" href="#exercise-3-revenue-per-customer" title="Permalink to this headline">¶</a></h3>
<p>Get the revenue generated by each customer for the month of 2014 January</p>
<ul class="simple">
<li><p>Tables - orders, order_items and customers</p></li>
<li><p>Data should be sorted in descending order by revenue and then ascending order by customer_id</p></li>
<li><p>Output should contain customer_id, customer_first_name, customer_last_name, customer_revenue.</p></li>
<li><p>If there are no orders placed by customer, then the corresponding revenue for a give customer should be 0.</p></li>
<li><p>Consider only COMPLETE and CLOSED orders</p></li>
</ul>
</div>
<div class="section" id="exercise-4-revenue-per-category">
<h3><span class="section-number">2.11.11.4. </span>Exercise 4 - Revenue Per Category<a class="headerlink" href="#exercise-4-revenue-per-category" title="Permalink to this headline">¶</a></h3>
<p>Get the revenue generated for each category for the month of 2014 January</p>
<ul class="simple">
<li><p>Tables - orders, order_items, products and categories</p></li>
<li><p>Data should be sorted in ascending order by category_id.</p></li>
<li><p>Output should contain all the fields from category along with the revenue as category_revenue.</p></li>
<li><p>Consider only COMPLETE and CLOSED orders</p></li>
</ul>
</div>
<div class="section" id="exercise-5-product-count-per-department">
<h3><span class="section-number">2.11.11.5. </span>Exercise 5 - Product Count Per Department<a class="headerlink" href="#exercise-5-product-count-per-department" title="Permalink to this headline">¶</a></h3>
<p>Get the products for each department.</p>
<ul class="simple">
<li><p>Tables - departments, categories, products</p></li>
<li><p>Data should be sorted in ascending order by department_id</p></li>
<li><p>Output should contain all the fields from department and the product count as product_count</p></li>
</ul>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "apache_toree_scala"
        },
        kernelOptions: {
            kernelName: "apache_toree_scala",
            path: "./02_basic_transformations"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'apache_toree_scala'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="11_conclusion_final_solution.html" title="previous page"><span class="section-number">2.10. </span>Basic Transformations</a>
    <a class='right-next' id="next-link" href="../03_basic_ddl_and_dml/01_basic_ddl_and_dml.html" title="next page"><span class="section-number">3. </span>Basic DDL and DML</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Durga Gadiraju<br/>
        
            &copy; Copyright ITVersity, Inc.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
    <!-- Google Analytics -->
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-80990145-12', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    <!-- End Google Analytics -->
    
  </body>
</html>